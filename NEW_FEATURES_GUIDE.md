# Руководство по новым функциям

Этот документ описывает новые функции, добавленные в бэкенд в рамках плана улучшения.

## 1. Аналитика

Модуль аналитики предоставляет эндпоинты для сбора статистики об обучении пользователей и популярности курсов.

### API Эндпоинты

-   `GET /analytics/users/:id`
    -   **Описание**: Получает подробную аналитику для конкретного пользователя, включая общий прогресс, потраченное время, средний балл за тесты, а также сильные и слабые стороны (темы).
    -   **Доступ**: Только для `ADMIN`.

-   `GET /analytics/current-user`
    -   **Описание**: Получает подробную аналитику для текущего авторизованного пользователя.
    -   **Доступ**: Любой авторизованный пользователь.

-   `GET /analytics/user/:id/time-spent`
    -   **Описание**: Возвращает общее время в минутах, потраченное пользователем на обучение.
    -   **Доступ**: `ADMIN` или сам пользователь.

-   `GET /analytics/user/:id/success-rate`
    -   **Описание**: Возвращает процент успешно пройденных тестов (балл >= 70%).
    -   **Доступ**: `ADMIN` или сам пользователь.

-   `GET /analytics/course/:id/popular-lessons`
    -   **Описание**: Возвращает список уроков в курсе, отсортированных по популярности (количеству завершений).
    -   **Доступ**: Любой авторизованный пользователь.

### Оптимизация

Запросы к базе данных в `AnalyticsService` были оптимизированы для уменьшения количества обращений и ускорения ответа, в частности, устранена проблема N+1 при выборке тем.

## 2. Система рекомендаций

Сервис рекомендаций был улучшен для предоставления более релевантных и адаптивных советов по обучению.

### Логика рекомендаций

1.  **Исправление слабых мест**: Если пользователь плохо справляется с тестами в какой-либо теме (`<70%`), система порекомендует ему более простые уроки (`difficulty <= 2`) из этой темы для закрепления материала.
2.  **Быстрый путь**: Если пользователь отлично справляется с темой (`>=95%`), система может предложить ему пропустить вводные уроки и перейти к более сложным (`difficulty >= 3`) в *следующей* теме, ускоряя его прогресс.
3.  **Стандартный путь**: Если нет явных слабых или сильных сторон, система порекомендует следующий по порядку урок в текущей теме.

### Кэширование

Результаты запросов к эндпоинтам рекомендаций (`/recommendations/*`) кэшируются на 5 минут для снижения нагрузки на сервер и ускорения повторных запросов.

## 3. Уведомления

Реализована возможность для пользователей управлять получением уведомлений.

### Настройки пользователя

-   В модели `User` добавлено поле `receiveNotifications` (тип `Boolean`, по умолчанию `true`).
-   Пользователь может изменить это значение через эндпоинт `PATCH /users/@me`, передав `{"receiveNotifications": false}`.
-   `NotificationsService` теперь проверяет этот флаг перед отправкой любого уведомления. Если он `false`, уведомление не создается и не отправляется.

## 4. Безопасность

### Ограничение частоты запросов (Rate Limiting)

Для защиты от спама и брутфорс-атак ко всем эндпоинтам API применено глобальное ограничение: не более 20 запросов в минуту с одного IP-адреса.

## 5. Тестирование

-   Добавлена базовая инфраструктура для unit-тестирования с использованием Jest и `ts-jest`.
-   Написаны unit-тесты для `AnalyticsService`, покрывающие основные сценарии расчета статистики. Это служит примером для дальнейшего расширения тестового покрытия.
