# Руководство по развертыванию Full-Stack приложения

Это руководство поможет вам развернуть full-stack приложение, состоящее из **Next.js** фронтенда и **NestJS** бэкенда, на платформах **Vercel** и **Render** соответственно.

## Содержание
1.  [Подготовка к развертыванию](#1-подготовка-к-развертыванию)
2.  [Часть 1: Развертывание Backend на Render](#2-часть-1-развертывание-backend-на-render)
3.  [Часть 2: Развертывание Frontend на Vercel](#3-часть-2-развертывание-frontend-на-vercel)
4.  [Часть 3: После развертывания](#4-часть-3-после-развертывания)

---

## 1. Подготовка к развертыванию
Перед началом убедитесь, что:
- Ваш проект находится в системе контроля версий Git (например, на GitHub, GitLab).
- У вас есть аккаунты на [Vercel](https://vercel.com/) и [Render](https://render.com/).

### Ключевые скрипты
- **Backend:**
  - `build`: `nest build` - собирает production-сборку.
  - `start:prod`: `node dist/main` - запускает собранное приложение.
- **Frontend:**
  - `build`: `next build` - собирает production-сборку.
  - `start`: `next start` - запускает собранное приложение.
  - `generate`: `orval --config ./orval.config.ts` - генерирует TypeScript клиент для API.

---

## 2. Часть 1: Развертывание Backend на Render

Бэкенд на NestJS вместе с базой данных PostgreSQL будет развернут на Render.

### Шаг 1: Создание базы данных PostgreSQL
1.  Перейдите в ваш [Dashboard на Render](https://dashboard.render.com/).
2.  Нажмите **"New +"** и выберите **"PostgreSQL"**.
3.  Придумайте имя для вашей базы данных (например, `educational-platform-db`).
4.  Выберите регион, ближайший к вашим пользователям.
5.  Нажмите **"Create Database"**.
6.  После создания базы данных перейдите на ее страницу и найдите раздел **"Connections"**. Скопируйте **"Internal Connection String"**. Она понадобится нам на следующем шаге.

### Шаг 2: Создание веб-сервиса для Backend
1.  В Dashboard на Render нажмите **"New +"** и выберите **"Web Service"**.
2.  Подключите ваш Git-репозиторий.
3.  Настройте сервис:
    - **Name**: Придумайте имя для вашего бэкенда (например, `educational-platform-backend`).
    - **Root Directory**: `backend` (укажите Render, что код находится в этой папке).
    - **Environment**: `Node`.
    - **Region**: Выберите тот же регион, что и для базы данных.
    - **Build Command**: `yarn && yarn build`
    - **Start Command**: `yarn start:prod`

4.  Перейдите во вкладку **"Environment"** и добавьте следующие переменные окружения:

| Ключ | Значение | Описание |
| :--- | :--- | :--- |
| `DATABASE_URL` | *вставьте скопированный Internal Connection String* | Адрес для подключения к вашей БД на Render. |
| `NODE_ENV` | `production` | Указывает, что приложение работает в production-режиме. |
| `HTTP_PORT` | `10000` | Render ожидает, что сервис будет работать на порту 10000. |
| `HTTP_HOST` | `0.0.0.0` | Сервер должен слушать все входящие подключения. |
| `JWT_SECRET` | *сгенерируйте случайную длинную строку* | Секрет для подписи JWT токенов. Можно использовать `openssl rand -hex 32`. |
| `COOKIES_SECRET` | *сгенерируйте случайную длинную строку* | Секрет для подписи cookie. |
| `JWT_ACCESS_TOKEN_TTL` | `15m` | Время жизни access-токена. |
| `JWT_REFRESH_TOKEN_TTL`| `7d` | Время жизни refresh-токена. |
| `HTTP_CORS` | *URL вашего фронтенда на Vercel* | Адрес фронтенда (например, `https://your-frontend.vercel.app`). |

5.  Нажмите **"Create Web Service"**. Render начнет процесс сборки и развертывания.

### Шаг 3: Выполнение миграций базы данных
После первого успешного развертывания база данных будет пустой. Вам нужно применить миграции.
1.  Перейдите на страницу вашего бэкенд-сервиса на Render.
2.  Откройте вкладку **"Shell"**.
3.  Выполните команду:
    ```bash
    yarn prisma migrate deploy
    ```
4.  (Опционально) Если вам нужно заполнить базу начальными данными, выполните команду:
    ```bash
    yarn db:seed
    ```

После этого ваш бэкенд готов к работе. Скопируйте его URL (вида `https://your-backend-name.onrender.com`).

---

## 3. Часть 2: Развертывание Frontend на Vercel

### Шаг 1: Подготовка
Убедитесь, что ваш бэкенд успешно развернут и работает.

### Шаг 2: Импорт проекта на Vercel
1.  Перейдите в ваш [Dashboard на Vercel](https://vercel.com/dashboard).
2.  Нажмите **"Add New..."** и выберите **"Project"**.
3.  Найдите и импортируйте ваш Git-репозиторий.
4.  Vercel автоматически определит, что это проект на Next.js.

### Шаг 3: Настройка проекта
1.  **Framework Preset**: Должен быть `Next.js`.
2.  **Root Directory**: `frontend` (укажите Vercel, что код находится в этой папке).
3.  Раскройте секцию **"Environment Variables"** и добавьте следующие переменные:

| Ключ | Значение | Описание |
| :--- | :--- | :--- |
| `NEXT_PUBLIC_API_BASE_URL` | *URL вашего бэкенда на Render* | Адрес бэкенда (например, `https://your-backend-name.onrender.com`). |
| `NEXT_PUBLIC_COOKIES_DOMAIN`| *Ваш домен на Vercel* | Домен, на котором будет доступен фронтенд (например, `your-frontend.vercel.app`). |

4. Нажмите **"Deploy"**. Vercel начнет сборку и развертывание вашего фронтенда.

---

## 4. Часть 3: После развертывания

1.  **Проверка работы**: Откройте URL вашего приложения на Vercel и убедитесь, что все работает: регистрация, вход, отображение курсов.
2.  **Просмотр логов**: Если что-то пошло не так, используйте вкладки "Logs" на Vercel и "Logs" на Render для диагностики проблем.
3.  **Пользовательские домены**: После того как вы убедитесь, что все работает, вы можете привязать свои собственные домены во вкладках "Domains" на Vercel и "Settings" на Render. Не забудьте обновить `HTTP_CORS` и `NEXT_PUBLIC_COOKIES_DOMAIN` после привязки доменов.
